# 2.2 向量索引

在上一节中我们介绍了什么是 embedding 以及产生 embedding 的一些常见方法，生成 embedding 后我们就需要对 embedding 进行检索，比较直观的方法就是我们直接通过 embedding 挨个计算的方法进行检索，这其实就是一种向量索引，叫做 Flat 方法（也叫做暴力检索），除了这种暴力检索外还有一些其他的通过空间换时间的向量索引方法，下面就让我们分别来介绍一下。

截止到目前，有一些系统所需检索的向量数据量已经达到数十亿甚至数百亿条，为了高效地在海量数据中进行向量相似性搜索，过去几十年中，学术界和工业界的专家们提出了众多针对向量数据的索引技术。

在深入探讨具体的向量索引技术之前，我们首先需要建立一个总体认识：目前几乎所有的向量索引技术都是通过对待查询的向量空间进行划分，将其分割成多个小的子空间。在搜索时，这些技术通过特定的方法快速定位与查询向量高度相似的一（或几个）子空间，从而显著提高检索效率。根据对空间划分数据结构的类型，我们可以将现有的向量索引技术大致分为以下五类：

1. **基于量化的向量索引方法**
2. **基于哈希的向量索引方法**
3. **基于树的向量索引方法**
4. **基于图的向量索引方法**
5. **基于混合的向量索引方法**。

下面对这 5 类向量索引做简单的介绍.

- **基于量化的向量索引方法**：这类方法通过将高维向量空间划分为有限数量的区域，并为每个区域选择一个代表向量（或称为码字）。在检索时，查询向量会被量化到最接近的代表向量所在的区域，从而快速找到相似的向量。这种方法包括乘积量化（Product Quantization, PQ）、标量量化（Scalar Quantization, SQ）等量化索引。
- **基于哈希的向量索引方法**：哈希方法通过将向量映射到哈希码，使得相似的向量有较高的概率共享相同的哈希值。局部敏感哈希（Locality Sensitive Hashing, LSH）是一种常用的技术，它能够保持向量之间的邻近性，从而在哈希表中快速找到近邻。
- **基于树的向量索引方法**：这类方法使用树形数据结构来组织向量空间，例如KD树和Ball树。树结构能够有效地将向量空间分割成多个区域，减少搜索时的比较次数，提高检索效率。
- **基于图的向量索引方法**：图方法通过构建近邻图（Nearest Neighbor Graph）来表示向量之间的相似关系。每个节点代表一个向量，边代表向量之间的相似度。在检索时，可以通过图搜索算法找到与查询向量最相似的向量。
- **基于混合的向量索引方法**：这类方法结合了上述几种技术的优点，以适应不同的数据特性和性能需求。例如，可以将量化方法与哈希方法结合，或者将树结构与图结构结合，以创建更高效、更精确的索引系统。

## 2.2.1 向量索引的评估指标

面对当前众多的向量索引技术，选择适合于特定应用的索引策略显得尤为关键。在本节中，我们将深入探讨几个关键的评估指标，并解析它们的重要性与实际意义。

首先，我们聚焦于**检索时延 (Latency)**。检索时延衡量的是从发起查询到接收结果所需的时长，它是衡量检索速度的核心指标，直接影响到用户体验和系统响应的效率。检索时延的计算公式为：**检索时延 = 接收查询结果的时间 - 发起查询的时间**。

接着是**每秒查询数 (Query Per Second, QPS)**，它表示系统在单位时间内能够处理的查询请求数量。QPS是衡量系统吞吐量的关键指标，它揭示了系统的并发处理能力。QPS的计算公式为：**QPS = 查询请求数 / 处理查询的时间**。

**召回率（Recall）**是向量检索中不可或缺的指标，它衡量的是系统检索所有相关向量的能力。具体来说，召回率是指在所有实际相关的向量中，被检索系统成功找到的比例。召回率的计算公式为：**召回率（Recall）=（检索到的相关向量数 / 实际相关向量总数）* 100%**。一个高召回率的系统意味着它能尽可能地检索到所有相关向量，避免遗漏关键信息。然而，由于向量空间的海量和高维特性，以及计算资源的限制，索引通常只能提供近似的检索结果。这种近似性可能导致索引遗漏相关向量或错误地包含不相关向量。因此，虽然召回率是衡量向量检索系统性能的重要指标，但在实际应用中，我们通常需要在召回率和其他指标（如精度、查询延迟等）之间寻求平衡。

**建索引时间**指的是创建索引所需的时长。它对系统的可用性和维护成本产生显著影响。建索引时间的计算公式为：**建索引时间 = 索引构建完成的时间 - 开始构建索引的时间**。

最后，我们关注**索引空间**。索引空间是指索引数据结构所占用的存储空间，它直接影响索引的可扩展性和资源消耗。

这些评估指标的重要性与意义在于，它们提供了一个全面的评估框架，帮助我们更深入地理解和比较不同的向量索引技术。通过这些指标，我们可以为特定的应用场景选择最合适的向量索引技术，实现检索速度、系统吞吐量和资源消耗之间的最佳平衡，从而实现高效向量检索。
